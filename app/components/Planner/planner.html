<!-- Loading Message -->
<div *ngIf="loading || !formattedMonth || !comingUp" class="loading-container">
	<div blur class="loading">
		<h1>Fetching Planner Data...</h1>
	</div>
</div>

<!-- Detect any click away from planner in this div -->
<div class="planner-interface">
	<!-- Planner -->
	<div *ngIf="!loading && formattedMonth && comingUp" class="planner-container container">
		<div class="calendar-container">
			<!-- Calendar including navigation bar -->
			<div class="calendar">
				<!-- Month navigation bar -->
				<div class="month-navigation">
					<button blur class="previous-month" (click)="previousMonth()">
						<span>
							<fa name="angle-left"></fa>
							Previous Month
						</span>
					</button>

					<button blur class="current-month" (click)="currentMonth()">
						{{ calendarDate.toDate() | date:'MMMM y' }}
					</button>

					<button blur class="next-month" (click)="nextMonth()">
						<span>
							Next Month
							<fa name="angle-right"></fa>
						</span>
					</button>
				</div>
				<!-- Calendar table (we used <div>'s this time!) -->
				<div blur class="calendar-grid">
					<div class="calendar-weekdays">
						<div *ngFor="let weekday of weekdays" class="weekday">
							{{ weekday }}
						</div>
					</div>
					<div *ngFor="let week of formattedMonth" class="calendar-week">
						<div *ngFor="let day of week" class="calendar-weekday" (click)="selectDay(day?.date, $event)">
							<div class="calendar-weekday-date" [class.today]="day?.today">
								{{ day?.date }}
							</div>
							<div *ngFor="let event of day?.events" class="event"
								[class.continue-left]="event?.inside.continueLeft"
								[class.continue-right]="event?.inside.continueRight"
								[style.background-color]="event?.data.class?.color || '#7F7F7F'"
								[style.border-right-color]="darkenColor(event?.data.class?.color, -20)"
								[style.border-bottom-color]="darkenColor(event?.data.class?.color, -20)">

								<div class="event-title">{{ event?.data.title }}</div>
								<div class="event-desc">{{ event?.data.descPlaintext }}</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div blur class="sidebar">
				<div class="sidebar-header" [class.coming-up]="selectionDay === null">
					<h1>
						<span *ngIf="selectionDay === null">Coming Up</span>
						<span *ngIf="selectionDay !== null">{{ selectionDay.toDate() | date:'MMMM d, y' }}</span>
					</h1>
				</div>
				<!-- View events coming up if no day is selected -->
				<div *ngIf="selectionDay === null" class="coming-up">
					<!-- Loop through each day that contains events coming up -->
					<div *ngFor="let day of comingUp" class="coming-up-day">
						<!-- Display date -->
						<div class="coming-up-due">
							<h3 class="due">Due {{ day.date.display }}</h3>
							<h3 class="date">{{ day.date.object.toDate() | date:'dd.MM.yy' }}</h3>
						</div>
						<div class="coming-up-events">
							<!-- List of events -->
							<div *ngFor="let event of day.events" class="event" (click)="viewEvent(event._id); viewEventModal.show()">
								<!-- Class info for each event -->
								<div class="event-class">
									<h4 class="event-class-name">{{ event.class?.name || event.class || 'Other' }}</h4>
									<h5 class="event-class-teacher">{{ event.class?.teacher?.firstName || '' }} {{ event.class?.teacher?.lastName || '' }}</h5>
								</div>
								<!-- Actual box with event -->
								<div class="event-content"
									[style.background-color]="event.class?.color || '#7F7F7F'"
									[style.border-right-color]="darkenColor(event.class?.color, -20)"
									[style.border-bottom-color]="darkenColor(event.class?.color, -20)">
									<!-- Manage and Manipulate Event -->
									<div class="event-manage btn-group">
										<!-- View -->
										<button class="btn btn-info btn-sm">
											<fa name="ellipsis-h"></fa>
										</button>
										<!-- Edit -->
										<button class="btn btn-warning btn-sm" (click)="viewEditEventModal(event._id, $event); editEventModal.show()">
											<fa name="pencil-square-o"></fa>
										</button>
										<!-- Delete -->
										<button class="btn btn-danger btn-sm" (click)="deleteEvent(event._id, $event)">
											<fa name="times"></fa>
										</button>
									</div>
									<!-- Event Title -->
									<div class="event-title">{{ event.title }}</div>
									<!-- Event description (including raw HTML) -->
									<div class="event-desc" [innerHTML]="event.desc"></div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- Show day events if a day is selected -->
				<div *ngIf="selectionDay !== null" class="day-selection">
					<!-- Create Event button at the top -->
					<button class="selection-create-event btn btn-info" (click)="createEventModal.show()">
						<span>
							<fa name="plus"></fa>
							Create Event
						</span>
					</button>
					<!-- Message if there are no events -->
					<div *ngIf="selectionEvents.length === 0" class="no-events">
						There are no events for this day.
					</div>
					<!-- Loop through events for that specific date -->
					<div *ngIf="selectionEvents.length > 0" class="selection-events">
						<!-- List of events -->
						<div *ngFor="let event of selectionEvents" class="event" (click)="viewEvent(event.data._id); viewEventModal.show()">
							<!-- Class info for each event -->
							<div class="event-class">
								<h4 class="event-class-name">{{ event.data.class?.name || event.data.class || 'Other' }}</h4>
								<h5 class="event-class-teacher">{{ event.data.class?.teacher?.firstName || '' }} {{ event.data.class?.teacher?.lastName || '' }}</h5>
							</div>
							<!-- Actual box with event -->
							<div class="event-content"
								[style.background-color]="event.data.class?.color || '#7F7F7F'"
								[style.border-right-color]="darkenColor(event.data.class?.color, -20)"
								[style.border-bottom-color]="darkenColor(event.data.class?.color, -20)">
								<!-- Manage and Manipulate Event -->
								<div class="event-manage btn-group">
									<!-- View -->
									<button class="btn btn-info btn-sm">
										<fa name="ellipsis-h"></fa>
									</button>
									<!-- Edit -->
									<button class="btn btn-warning btn-sm" (click)="viewEditEventModal(event.data._id, $event); editEventModal.show()">
										<fa name="pencil-square-o"></fa>
									</button>
									<!-- Delete -->
									<button class="btn btn-danger btn-sm" (click)="deleteEvent(event.data._id, $event)">
										<fa name="times"></fa>
									</button>
								</div>
								<!-- Event Title -->
								<div class="event-title">{{ event.data.title }}</div>
								<!-- Event description (including raw HTML) -->
								<div class="event-desc" [innerHTML]="event.data.desc"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Modal for creating events -->
<div bsModal #createEventModal="bs-modal" class="create-event-modal modal fade" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title">Create a Planner Event</h4>
			</div>
			<div class="modal-body">
				<form #createEventForm="ngForm" novalidate>
					<fieldset class="form-group" [class.has-danger]="createEventTitle.dirty && !createEventTitle.valid">
						<legend>Event Title</legend>
						<input #createEventTitle="ngModel" class="form-control" [class.form-control-danger]="createEventTitle.dirty && !createEventTitle.valid" name="title" [(ngModel)]="createEventModel.title" placeholder="Title" required>
						<p *ngIf="createEventTitle.dirty && !createEventTitle.valid" class="form-control-feedback">Title is required</p>
					</fieldset>
					<fieldset class="form-group">
						<legend>Event Description</legend>
						<textarea class="form-control" name="desc" [(ngModel)]="createEventModel.desc" placeholder="Description" autocomplete="off" rows="5"></textarea>
					</fieldset>
					<fieldset class="form-group">
						<legend>Event Class</legend>
						<select class="custom-select" name="classId" [(ngModel)]="createEventModel.classId">
							<option *ngFor="let class of classes" [value]="class._id">{{class.name}}</option>
							<option value="other" selected>Other</option>
						</select>
					</fieldset>
					<div class="event-date">
						<fieldset class="form-group">
							<legend>Event Start</legend>
							<datepicker name="start" [(ngModel)]="createEventModel.start" [showWeeks]="false"></datepicker>
						</fieldset>
						<fieldset class="form-group">
							<legend>Event End</legend>
							<datepicker name="end" [(ngModel)]="createEventModel.end" [showWeeks]="false"></datepicker>
						</fieldset>
					</div>
					<p *ngIf="!consecutiveDates(createEventModel.start, createEventModel.end)" class="text-danger">Start and end dates must be consecutive!</p>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" (click)="createEvent(); createEventModal.hide()" [disabled]="!createEventForm.valid || !consecutiveDates(createEventModel.start, createEventModel.end)">Create Event</button>
			</div>
		</div>
	</div>
</div>

<!-- Modal for viewing events -->
<div bsModal #viewEventModal="bs-modal" class="view-event-modal modal fade" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title">{{ viewEventObject?.title }}</h4>
				<p class="event-modal-subtitle text-muted">{{ viewEventObject?.start | date }} - {{ viewEventObject?.end | date }}</p>
			</div>
			<div class="modal-body" [innerHTML]="viewEventObject?.desc"></div>
			<div class="modal-footer">
				<!-- Maybe someday... -->
				<!-- <button class="btn btn-success">Cross out as Completed</button> -->
				<button class="btn btn-warning" (click)="viewEventModal.hide(); viewEditEventModal(viewEventObject._id, $event); editEventModal.show()">Edit</button>
				<button class="btn btn-danger" (click)="deleteEvent(viewEventObject._id, $event); viewEventModal.hide()">Delete</button>
			</div>
		</div>
	</div>
</div>

<!-- Modal for editing events -->
<div bsModal #editEventModal="bs-modal" class="edit-event-modal modal fade" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title">Edit a Planner Event</h4>
			</div>
			<div class="modal-body">
				<form #editEventForm="ngForm" novalidate>
					<fieldset class="form-group" [class.has-danger]="editEventTitle.dirty && !editEventTitle.valid">
						<legend>Event Title</legend>
						<input #editEventTitle="ngModel" class="form-control" [class.form-control-danger]="editEventTitle.dirty && !editEventTitle.valid" name="title" [(ngModel)]="editEventModel.title" placeholder="Title" required>
						<p *ngIf="editEventTitle.dirty && !editEventTitle.valid" class="form-control-feedback">Title is required</p>
					</fieldset>
					<fieldset class="form-group">
						<legend>Event Description</legend>
						<textarea class="form-control" name="desc" [(ngModel)]="editEventModel.desc" placeholder="Description" autocomplete="off" rows="5"></textarea>
					</fieldset>
					<fieldset class="form-group">
						<legend>Event Class</legend>
						<select class="custom-select" name="classId" [(ngModel)]="editEventModel.classId">
							<option *ngFor="let class of classes" [value]="class._id">{{class.name}}</option>
							<option value="other" selected>Other</option>
						</select>
					</fieldset>
					<div class="event-date">
						<fieldset class="form-group">
							<legend>Event Start</legend>
							<datepicker name="start" [(ngModel)]="editEventModel.start" [showWeeks]="false"></datepicker>
						</fieldset>
						<fieldset class="form-group">
							<legend>Event End</legend>
							<datepicker name="end" [(ngModel)]="editEventModel.end" [showWeeks]="false"></datepicker>
						</fieldset>
					</div>
					<p *ngIf="!consecutiveDates(editEventModel.start, editEventModel.end)" class="text-danger">Start and end dates must be consecutive!</p>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" (click)="editEvent(); editEventModal.hide()" [disabled]="!editEventForm.valid || !consecutiveDates(editEventModel.start, editEventModel.end)">Edit Event</button>
			</div>
		</div>
	</div>
</div>
